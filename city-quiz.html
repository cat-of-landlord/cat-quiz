<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸­å›½åœ°çº§å¸‚å¡«å›¾æŒ‘æˆ˜ | åœ°ç†é—®ç­”</title>
    <style>
        /* å…¨å±€æ ·å¼é‡ç½® */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft YaHei", Arial, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* å¤´éƒ¨æ ·å¼ - æ–°å¢è¿”å›æŒ‰é’®æ ·å¼ */
        header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 1.5rem 2rem;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            flex-shrink: 0;
            position: relative; /* æ–°å¢ï¼šä¸ºè¿”å›æŒ‰é’®å®šä½ */
        }

        /* æ–°å¢ï¼šè¿”å›æŒ‰é’®æ ·å¼ */
        .back-btn {
            position: absolute;
            left: 2rem;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 0.5rem 1.2rem;
            border-radius: 20px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
        }

        .back-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-50%) scale(1.05);
        }

        .stats-bar {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .stat-item {
            background: rgba(255,255,255,0.2);
            padding: 0.5rem 1.2rem;
            border-radius: 20px;
            font-size: 1rem;
        }

        .stat-number {
            font-weight: bold;
            color: #3498db;
            font-size: 1.2rem;
        }

        /* ä¸»å®¹å™¨ */
        .main-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
            padding: 2rem 1rem;
        }

        /* åœ°å›¾å’Œåˆ—è¡¨å®¹å™¨ */
        .content-wrapper {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
            flex: 1;
        }

        @media (max-width: 992px) {
            .content-wrapper {
                grid-template-columns: 1fr;
            }
        }

        /* åœ°å›¾åŒºåŸŸ - ç§»é™¤æ»šåŠ¨æ¡ï¼Œä¼˜åŒ–æ‹–åŠ¨ */
        .map-section {
            background: white;
            padding: 1rem;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            position: relative;
            overflow: hidden;
            height: 600px;
        }

        /* æ–°å¢ï¼šåœ°å›¾ä½¿ç”¨æç¤º */
        .map-tip {
            padding: 0.8rem 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 0.8rem;
            font-size: 0.9rem;
            color: #555;
            line-height: 1.5;
            border-left: 3px solid #3498db;
        }

        .map-wrapper {
            width: 100%;
            height: calc(100% - 50px); /* é¢„ç•™æç¤ºæ¡†é«˜åº¦ */
            position: relative;
            overflow: hidden;
            cursor: pointer; /* ä¿®æ”¹ï¼šæ”¹ä¸ºç‚¹å‡»æ”¾å¤§çš„å…‰æ ‡ */
        }

        #city-svg {
            width: 100%;
            height: 100%;
            min-width: 800px;
            min-height: 600px;
            transition: transform 0.3s ease; /* ä¿®æ”¹ï¼šå»¶é•¿è¿‡æ¸¡åŠ¨ç”» */
        }

        /* ç§»é™¤åœ°å›¾æ§åˆ¶æŒ‰é’®ç›¸å…³æ ·å¼ */

        /* çœä»½åˆ—è¡¨åŒºåŸŸ */
        .province-list {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            max-height: 600px;
            overflow-y: auto;
        }

        .province-group {
            margin-bottom: 1.5rem;
            border-bottom: 1px solid #eee;
            padding-bottom: 1rem;
        }

        .province-name {
            font-size: 1.1rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 0.8rem;
            display: flex;
            justify-content: space-between;
        }

        .province-progress {
            font-size: 0.9rem;
            color: #7f8c8d;
        }

        .city-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .city-tag {
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.9rem;
            background: #ecf0f1;
            color: #7f8c8d;
            transition: all 0.3s;
            display: none;
        }

        .city-tag.filled {
            display: inline-block;
            background: #2ecc71;
            color: white;
        }

        /* æ–°å¢ï¼šæœªç­”å‡ºçš„åŸå¸‚æ ·å¼ */
        .city-tag.unfilled {
            display: inline-block;
            background: #e74c3c;
            color: white;
        }

        /* è¾“å…¥æ åŒºåŸŸ - ç§»é™¤è”æƒ³ç›¸å…³æ ·å¼ */
        .input-section-container {
            position: sticky;
            bottom: 0;
            background: white;
            padding: 1.5rem 2rem;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            border-top: 1px solid #e0e0e0;
            z-index: 1000;
            margin-top: auto;
            transition: all 0.3s ease;
        }

        .input-section {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .input-wrapper {
            flex: 1;
            min-width: 300px;
            position: relative;
        }

        #city-input {
            width: 100%;
            padding: 0.8rem 1rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.3s;
        }

        #city-input:focus {
            border-color: #3498db;
        }

        /* æŒ‰é’®æ ·å¼ */
        .button-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .btn-submit {
            background: #3498db;
            color: white;
        }

        .btn-submit:hover {
            background: #2980b9;
        }

        .btn-end {
            background: #9b59b6;
            color: white;
        }

        .btn-end:hover {
            background: #8e44ad;
        }

        .btn-reset {
            background: #e74c3c;
            color: white;
        }

        .btn-reset:hover {
            background: #c0392b;
        }

        /* æç¤ºæ¶ˆæ¯ */
        .message {
            width: 100%;
            margin-top: 1rem;
            padding: 0.8rem;
            border-radius: 8px;
            font-weight: bold;
            display: none;
        }

        .success {
            background: #d5f5e3;
            color: #27ae60;
            display: block;
        }

        .error {
            background: #fadbd8;
            color: #e74c3c;
            display: block;
        }

        /* ç»“æœå¼¹çª— */
        .result-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .result-content {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            max-width: 800px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            text-align: center;
        }

        .result-title {
            font-size: 1.5rem;
            color: #2c3e50;
            margin-bottom: 1.5rem;
        }

        .result-stats {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .result-stat {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #eee;
        }

        .result-label {
            color: #7f8c8d;
        }

        .result-value {
            font-weight: bold;
            color: #2c3e50;
        }

        .result-accuracy {
            font-size: 1.2rem;
            color: #e74c3c;
        }

        /* é‡ç½®æŒ‰é’® */
        .reset-section {
            text-align: center;
            margin-top: 2rem;
            flex-shrink: 0;
        }

        /* åŸå¸‚åç§°æç¤ºæ¡† - ä¿®æ”¹ä½ç½®æ ·å¼ */
        .city-tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-size: 0.9rem;
            pointer-events: none;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.2s ease;
            white-space: nowrap;
            /* æ–°å¢ï¼šé˜²æ­¢æç¤ºæ¡†è¢«é®æŒ¡ */
            z-index: 9999;
        }

        /* å“åº”å¼é€‚é… */
        @media (max-width: 768px) {
            .main-container {
                padding: 1rem;
            }
            
            .content-wrapper {
                gap: 1rem;
            }
            
            .map-section, .province-list {
                max-height: 500px;
            }
            
            .input-section {
                flex-direction: column;
            }
            
            .input-wrapper {
                min-width: 100%;
            }
            
            .button-group {
                width: 100%;
            }
            
            .btn {
                flex: 1;
                text-align: center;
            }
            
            .stats-bar {
                gap: 1rem;
            }
            
            .stat-item {
                padding: 0.3rem 0.8rem;
                font-size: 0.9rem;
            }

            /* å“åº”å¼è°ƒæ•´è¿”å›æŒ‰é’® */
            .back-btn {
                padding: 0.3rem 0.8rem;
                font-size: 0.9rem;
                left: 1rem;
            }

            /* å“åº”å¼è°ƒæ•´åœ°å›¾æç¤º */
            .map-tip {
                font-size: 0.8rem;
                padding: 0.6rem 0.8rem;
            }

            .map-wrapper {
                height: calc(100% - 45px);
            }
        }

        @media (max-width: 576px) {
            .map-section {
                height: 400px;
            }
            
            .province-list {
                max-height: 400px;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }

        /* æ­£ç¡®ç‡ç»Ÿè®¡åŒºåŸŸæ ·å¼ */
        .accuracy-stats {
            margin-top: 2rem;
            max-height: 400px;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .accuracy-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.5rem 0;
            border-bottom: 1px solid #eee;
        }

        .city-name {
            width: 120px;
            text-align: left;
            font-size: 0.9rem;
        }

        .progress-bar {
            flex: 1;
            height: 8px;
            background-color: #ff4444; /* é”™è¯¯çº¢è‰²åº• */
            border-radius: 4px;
            overflow: hidden;
        }

        .correct-progress {
            height: 100%;
            background-color: #4CAF50; /* æ­£ç¡®ç»¿è‰²æ¡ */
        }

        .percent-text {
            width: 40px;
            text-align: right;
            font-size: 0.9rem;
            font-weight: bold;
        }

        /* æ–°å¢æ ·å¼ï¼šæœŸæœ›åˆ†å€¼å’Œæ­£æ€åˆ†å¸ƒç»Ÿè®¡ */
        .stat-detail {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
            line-height: 1.4;
        }
        .highlight-val {
            color: #2c3e50;
            font-weight: bold;
        }
        /* ç»“æœæ»šåŠ¨åŒºåŸŸä¼˜åŒ– */
        .city-stats-list {
            margin-top: 20px;
            border-top: 1px solid #eee;
            padding-top: 15px;
        }
        .city-stat-row {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .bar-container {
            flex: 1;
            height: 8px;
            background-color: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
        }
        .bar-fill {
            height: 100%;
            background-color: #ff4444;
            transition: width 0.3s ease;
        }
        .bar-fill.correct {
            background-color: #4CAF50;
        }
        .final-stats {
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <!-- å¤´éƒ¨ï¼šæ ‡é¢˜å’Œç»Ÿè®¡ - æ–°å¢è¿”å›æŒ‰é’® -->
    <header>
        <a href="index.html" class="back-btn">â† è¿”å›é¦–é¡µ</a>
        <h1>ä¸­å›½åœ°çº§å¸‚å¡«å›¾æŒ‘æˆ˜</h1>
        <div class="stats-bar">
            <div class="stat-item">å·²å¡«/æ€»æ•°ï¼š<span id="filled-count" class="stat-number">0</span>/<span id="total-count" class="stat-number">0</span></div>
            <div class="stat-item">ç”¨æ—¶ï¼š<span id="timer" class="stat-number">00:00</span></div>
        </div>
    </header>

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <div class="main-container">
        <!-- åœ°å›¾å’Œçœä»½åˆ—è¡¨ -->
        <div class="content-wrapper">
            <!-- åœ°å›¾åŒºåŸŸ - ç§»é™¤åœ°å›¾æ§åˆ¶æŒ‰é’® -->
            <div class="map-section">
                <!-- æ–°å¢ï¼šåœ°å›¾ä½¿ç”¨æç¤ºå£°æ˜ -->
                <div class="map-tip">
                    ğŸ” å¡«å†™è§„åˆ™ï¼š1.ç›´è¾–å¸‚/ç‰¹åˆ«è¡Œæ”¿åŒºç›´æ¥è¾“å…¥åç§°ï¼ˆå¦‚ï¼šåŒ—äº¬ã€é¦™æ¸¯ï¼‰ï¼›2.çœçº§ç›´è¾–å¿éœ€è¾“å…¥å¿åå¦‚:xxå¿ï¼ˆç®—åœ°çº§ï¼‰ï¼›3.è‡ªæ²»å·å¯è¾“å…¥ç®€å†™ï¼›4.åœ°å›¾å•å‡»ä»»æ„ä½ç½®æ”¾å¤§ï¼ˆä»¥ç‚¹å‡»ä½ç½®ä¸ºä¸­å¿ƒï¼‰ï¼Œå†æ¬¡å•å‡»å¤åŸã€‚5.é¼ æ ‡æ‚¬æµ®å¯ä»¥æ˜¾ç¤ºå·²ç­”å‡ºåŸå¸‚å
                </div>
                <div class="map-wrapper" id="map-wrapper">
                    <object id="city-svg" data="cities_new.svg" type="image/svg+xml"></object>
                    <!-- åŸå¸‚åç§°æç¤ºæ¡† -->
                    <div class="city-tooltip" id="city-tooltip"></div>
                </div>
            </div>

            <!-- çœä»½åˆ—è¡¨åŒºåŸŸ -->
            <div class="province-list" id="province-list"></div>
        </div>

        <!-- é‡ç½®æŒ‰é’® -->
        <div class="reset-section">
            <button id="reset-btn" class="btn btn-reset">é‡æ–°å¼€å§‹æŒ‘æˆ˜</button>
        </div>
    </div>

    <!-- è¾“å…¥æ ï¼ˆå›ºå®šåœ¨åº•éƒ¨ï¼‰- ç§»é™¤è”æƒ³è¾“å…¥æ¡† -->
    <div class="input-section-container">
        <div class="input-section">
            <div class="input-wrapper">
                <input type="text" id="city-input" placeholder="è¾“å…¥åœ°çº§å¸‚åç§°ï¼ˆæ”¯æŒç®€å†™ï¼Œå¦‚ï¼šåŒ—äº¬ã€é¦™æ¸¯ç­‰ï¼‰" autocomplete="off">
            </div>
            <div class="button-group">
                <button id="submit-btn" class="btn btn-submit">æäº¤ç­”æ¡ˆ</button>
                <button id="end-btn" class="btn btn-end">ç»“æŸæŒ‘æˆ˜</button>
            </div>
            <div class="message" id="message"></div>
        </div>
    </div>

    <!-- ç»“æœå¼¹çª— -->
    <div class="result-modal" id="result-modal">
        <div class="result-content">
            <h2 class="result-title">æŒ‘æˆ˜ç»“æŸï¼</h2>
            <div id="final-stats" class="final-stats"></div>
            <div class="result-stats" id="result-stats"></div>
            <button id="close-result-btn" class="btn btn-reset">å…³é—­</button>
            <div class="city-stats-list" id="city-stats-list">
                <h3 style="margin-bottom: 1rem; font-size: 1.1rem; color: #2c3e50;">å…¨ç½‘åŸå¸‚è¯†åˆ«çƒ­åº¦æ¦œï¼ˆç»¿è‰²ä¸ºæ‚¨ç­”å¯¹ï¼‰</h3>
            </div>
        </div>
    </div>

    <script>
        // æ ¸å¿ƒæ•°æ®å­˜å‚¨
        let cityData = {};
        let mergedData = {};
        let allCities = [];
        let filledCities = new Set();
        let totalAttempts = 0;
        let correctAttempts = 0;
        let timerInterval = null;
        let startTime = 0;
        let isGameEnded = false;
        let accuracyData = []; // å­˜å‚¨city_accuracy.jsonçš„å†…å®¹

        // åœ°å›¾ç¼©æ”¾ç›¸å…³å˜é‡ - ç®€åŒ–ä¸ºä»…è®°å½•æ”¾å¤§çŠ¶æ€
        let isZoomed = false; // æ˜¯å¦æ”¾å¤§
        let scale = 1;
        let translateX = 0;
        let translateY = 0;
        let originalViewBox = ''; // ä¿å­˜åŸå§‹viewBox
        
        // æç¤ºæ¡†å…ƒç´ 
        const tooltip = document.getElementById('city-tooltip');

        // ç®€å†™æ˜ å°„è¡¨ - è¡¥å……æ‰€æœ‰é—æ¼çš„è‡ªæ²»å·ç®€å†™
        const shortNameMap = {
            // ç‰¹åˆ«è¡Œæ”¿åŒºç®€å†™
            'é¦™æ¸¯': 'é¦™æ¸¯ç‰¹åˆ«è¡Œæ”¿åŒº',
            'æ¾³é—¨': 'æ¾³é—¨ç‰¹åˆ«è¡Œæ”¿åŒº',
            // é’æµ·çœè‡ªæ²»å·
            'æµ·å—': 'æµ·å—è—æ—è‡ªæ²»å·',
            'æµ·åŒ—': 'æµ·åŒ—è—æ—è‡ªæ²»å·',
            'é»„å—': 'é»„å—è—æ—è‡ªæ²»å·',
            'æœæ´›': 'æœæ´›è—æ—è‡ªæ²»å·',
            'ç‰æ ‘': 'ç‰æ ‘è—æ—è‡ªæ²»å·',
            'æµ·è¥¿': 'æµ·è¥¿è’™å¤æ—è—æ—è‡ªæ²»å·',
            // æ–°ç–†è‡ªæ²»åŒºè‡ªæ²»å·
            'æ˜Œå‰': 'æ˜Œå‰å›æ—è‡ªæ²»å·',
            'åšå°”å¡”æ‹‰': 'åšå°”å¡”æ‹‰è’™å¤è‡ªæ²»å·',
            'å·´éŸ³éƒ­æ¥': 'å·´éŸ³éƒ­æ¥è’™å¤è‡ªæ²»å·',
            'å…‹å­œå‹’è‹': 'å…‹å­œå‹’è‹æŸ¯å°”å…‹å­œè‡ªæ²»å·',
            'ä¼ŠçŠ': 'ä¼ŠçŠå“ˆè¨å…‹è‡ªæ²»å·',
            // æ¹–å—çœè‡ªæ²»å·
            'æ¹˜è¥¿': 'æ¹˜è¥¿åœŸå®¶æ—è‹—æ—è‡ªæ²»å·',
            // æ¹–åŒ—çœè‡ªæ²»å·
            'æ©æ–½': 'æ©æ–½åœŸå®¶æ—è‹—æ—è‡ªæ²»å·',
            // å‰æ—çœè‡ªæ²»å·
            'å»¶è¾¹': 'å»¶è¾¹æœé²œæ—è‡ªæ²»å·',
            // å››å·çœè‡ªæ²»å·
            'é˜¿å': 'é˜¿åè—æ—ç¾Œæ—è‡ªæ²»å·',
            'ç”˜å­œ': 'ç”˜å­œè—æ—è‡ªæ²»å·',
            'å‡‰å±±': 'å‡‰å±±å½æ—è‡ªæ²»å·',
            // è´µå·çœè‡ªæ²»å·
            'é»”ä¸œå—': 'é»”ä¸œå—è‹—æ—ä¾—æ—è‡ªæ²»å·',
            'é»”å—': 'é»”å—å¸ƒä¾æ—è‹—æ—è‡ªæ²»å·',
            'é»”è¥¿å—': 'é»”è¥¿å—å¸ƒä¾æ—è‹—æ—è‡ªæ²»å·',
            // äº‘å—çœè‡ªæ²»å·
            'è¥¿åŒç‰ˆçº³': 'è¥¿åŒç‰ˆçº³å‚£æ—è‡ªæ²»å·',
            'å¾·å®': 'å¾·å®å‚£æ—æ™¯é¢‡æ—è‡ªæ²»å·',
            'æ€’æ±Ÿ': 'æ€’æ±Ÿå‚ˆåƒ³æ—è‡ªæ²»å·',
            'è¿ªåº†': 'è¿ªåº†è—æ—è‡ªæ²»å·',
            'çº¢æ²³': 'çº¢æ²³å“ˆå°¼æ—å½æ—è‡ªæ²»å·',
            'æ–‡å±±': 'æ–‡å±±å£®æ—è‹—æ—è‡ªæ²»å·',
            'æ¥šé›„': 'æ¥šé›„å½æ—è‡ªæ²»å·',
            'å¤§ç†': 'å¤§ç†ç™½æ—è‡ªæ²»å·',
            // ç”˜è‚ƒçœè‡ªæ²»å·
            'ä¸´å¤': 'ä¸´å¤å›æ—è‡ªæ²»å·',
            'ç”˜å—': 'ç”˜å—è—æ—è‡ªæ²»å·'
        };

        // åˆå§‹åŒ–å‡½æ•°
        async function init() {
            try {
                // åŒæ—¶åŠ è½½åŸå¸‚åˆ—è¡¨å’Œæ­£ç¡®ç‡æ•°æ®
                const [cityListData, accData] = await Promise.all([
                    fetch('province_city_list.json').then(r => r.json()),
                    fetch('city_accuracy.json').then(r => r.json())
                ]);

                cityData = cityListData;
                accuracyData = accData.city_accuracy_list;
                
                // åˆå¹¶ç‰¹æ®ŠåŒºåŸŸ
                mergeSpecialRegions();
                
                // æ•´ç†æ‰€æœ‰åŸå¸‚åˆ—è¡¨
                for (const province in mergedData) {
                    allCities = [...allCities, ...mergedData[province]];
                }
                allCities = [...new Set(allCities)];
                document.getElementById('total-count').textContent = allCities.length;

                // æ¸²æŸ“çœä»½åˆ—è¡¨
                renderProvinceList();

                // åˆå§‹åŒ–SVGäº¤äº’
                initSVGInteraction();

                // å¯åŠ¨è®¡æ—¶å™¨
                startTimer();

                console.log("åˆå§‹åŒ–å®Œæˆï¼Œæ€»åŸå¸‚æ•°ï¼š", allCities.length);
                console.log("æ­£ç¡®ç‡æ•°æ®åŠ è½½å®Œæˆï¼Œæ•°é‡ï¼š", accuracyData.length);
            } catch (error) {
                showMessage("åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥province_city_list.jsonå’Œcity_accuracy.jsonæ˜¯å¦åœ¨åŒä¸€ç›®å½•ï¼", "error");
                console.error("æ•°æ®åŠ è½½é”™è¯¯ï¼š", error);
            }
        }

        // åˆå¹¶ç‰¹æ®ŠåŒºåŸŸ
        function mergeSpecialRegions() {
            const specialRegions = [
                "åŒ—äº¬å¸‚", "å¤©æ´¥å¸‚", "ä¸Šæµ·å¸‚", "é‡åº†å¸‚", 
                "é¦™æ¸¯ç‰¹åˆ«è¡Œæ”¿åŒº", "æ¾³é—¨ç‰¹åˆ«è¡Œæ”¿åŒº"
            ];
            const mergedCities = [];
            
            specialRegions.forEach(region => {
                if (cityData[region]) {
                    mergedCities.push(...cityData[region]);
                    delete cityData[region];
                }
            });
            
            mergedData = {
                "ç›´è¾–å¸‚åŠç‰¹åˆ«è¡Œæ”¿åŒº": mergedCities,
                ...cityData
            };
        }

        // æ¸²æŸ“çœä»½åˆ—è¡¨
        function renderProvinceList() {
            const listContainer = document.getElementById('province-list');
            listContainer.innerHTML = '';

            for (const province in mergedData) {
                const cities = mergedData[province];
                const filledInProvince = cities.filter(city => filledCities.has(city)).length;

                const provinceGroup = document.createElement('div');
                provinceGroup.className = 'province-group';
                
                const provinceName = document.createElement('div');
                provinceName.className = 'province-name';
                provinceName.innerHTML = `
                    ${province} 
                    <span class="province-progress">${filledInProvince}/${cities.length}</span>
                `;
                
                const cityTags = document.createElement('div');
                cityTags.className = 'city-tags';
                
                cities.forEach(city => {
                    const cityTag = document.createElement('div');
                    
                    // å¦‚æœæ¸¸æˆå·²ç»“æŸï¼Œæ˜¾ç¤ºæ‰€æœ‰åŸå¸‚
                    if (isGameEnded) {
                        if (filledCities.has(city)) {
                            cityTag.className = 'city-tag filled';
                        } else {
                            cityTag.className = 'city-tag unfilled';
                        }
                    } else {
                        // æ¸¸æˆè¿›è¡Œä¸­ï¼Œåªæ˜¾ç¤ºå·²ç­”å‡ºçš„åŸå¸‚
                        cityTag.className = `city-tag ${filledCities.has(city) ? 'filled' : ''}`;
                    }
                    
                    cityTag.textContent = city;
                    cityTags.appendChild(cityTag);
                });
                
                provinceGroup.appendChild(provinceName);
                provinceGroup.appendChild(cityTags);
                listContainer.appendChild(provinceGroup);
            }
        }

        // åˆå§‹åŒ–SVGäº¤äº’
        function initSVGInteraction() {
            const svgObj = document.getElementById('city-svg');
            const mapWrapper = document.getElementById('map-wrapper');
            
            // ç¡®ä¿ SVG åŠ è½½å®Œæˆåå†ç»‘å®š
            svgObj.addEventListener('load', function() {
                const svgDoc = this.contentDocument;
                if (!svgDoc) return;
                const svgElement = svgDoc.querySelector('svg');
                if (!svgElement) return;

                // --- æ ¸å¿ƒä¿®å¤ï¼šç›‘å¬å™¨å¿…é¡»ç»‘å®šåœ¨ svgDoc æˆ– svgElement ä¸Š ---
                svgDoc.addEventListener('click', (e) => {
                    // è·å–ç‚¹å‡»ä½ç½®ï¼ˆç›¸å¯¹äº SVG è§†å£ï¼‰
                    const clickX = e.clientX;
                    const clickY = e.clientY;
                    
                    // æ‰§è¡Œæ”¾å¤§/ç¼©å°åˆ‡æ¢
                    toggleZoom(svgElement, clickX, clickY);
                });

                // åŸæœ‰çš„åŸå¸‚å…ƒç´ é€»è¾‘
                const cityElements = svgDoc.querySelectorAll('[data-name]');
                cityElements.forEach(elem => {
                    const cityName = elem.getAttribute('data-name').trim();
                    if (!cityName) return;

                    elem.style.transition = 'fill 0.3s';
                    elem.style.cursor = 'pointer'; 

                    elem.addEventListener('mouseover', function(e) {
                        if (filledCities.has(cityName)) {
                            showTooltip(e, cityName);
                        } else if (!isGameEnded) {
                            this.style.fill = '#3498db';
                        }
                    });

                    elem.addEventListener('mouseout', function() {
                        hideTooltip();
                        if (!filledCities.has(cityName) && !isGameEnded) {
                            this.style.fill = '';
                        }
                    });
                });
            });
        }

        // ä¼˜åŒ–åçš„æ”¾å¤§å‡½æ•°
        function toggleZoom(svgElement, clickX, clickY) {
            if (isZoomed) {
                // å¤åŸï¼šæ¸…é™¤å˜æ¢
                svgElement.style.transform = `translate(0px, 0px) scale(1)`;
                isZoomed = false;
                document.getElementById('map-wrapper').style.cursor = 'zoom-in';
            } else {
                // æ”¾å¤§ï¼šå»ºè®®å€æ•°è°ƒé«˜ä¸€ç‚¹æ–¹ä¾¿æŸ¥çœ‹ï¼Œä¾‹å¦‚ 2.5
                const zoomScale = 2.5; 
                
                // è®¡ç®—åç§»ï¼šè®©ç‚¹å‡»çš„ç‚¹ç§»åŠ¨åˆ°å®¹å™¨ä¸­å¿ƒ
                // å…¬å¼ï¼šåç§»é‡ = å®¹å™¨ä¸­å¿ƒ - (ç‚¹å‡»ä½ç½® * ç¼©æ”¾å€æ•°)
                const rect = document.getElementById('map-wrapper').getBoundingClientRect();
                const centerX = rect.width / 2;
                const centerY = rect.height / 2;
                
                translateX = centerX - (clickX * zoomScale);
                translateY = centerY - (clickY * zoomScale);

                // åº”ç”¨å˜æ¢
                svgElement.style.transition = "transform 0.4s cubic-bezier(0.4, 0, 0.2, 1)";
                svgElement.style.transformOrigin = '0 0';
                svgElement.style.transform = `translate(${translateX}px, ${translateY}px) scale(${zoomScale})`;
                
                isZoomed = true;
                document.getElementById('map-wrapper').style.cursor = 'zoom-out';
            }
        }

        // åŒ¹é…åŸå¸‚åç§°ï¼ˆå»é™¤æ¨¡ç³Šæœç´¢ï¼Œåªæ”¯æŒç®€å†™ï¼‰
        function matchCity(input) {
            const normalizedInput = input.trim();
            
            // 1. é¦–å…ˆå°è¯•å®Œå…¨åŒ¹é…
            if (allCities.includes(normalizedInput)) {
                return normalizedInput;
            }
            
            // 2. å°è¯•ç®€å†™æ˜ å°„
            if (shortNameMap[normalizedInput]) {
                return shortNameMap[normalizedInput];
            }
            
            // 3. å°è¯•å»æ‰åç¼€è¿›è¡Œç²¾ç¡®åŒ¹é…
            const suffixes = ['å¸‚', 'ç‰¹åˆ«è¡Œæ”¿åŒº', 'è‡ªæ²»å·', 'åœ°åŒº', 'ç›Ÿ', 'æ—åŒº'];
            
            // éå†æ‰€æœ‰åŸå¸‚ï¼Œæ£€æŸ¥è¾“å…¥æ˜¯å¦åŒ¹é…å»æ‰åç¼€çš„åŸå¸‚å
            for (const city of allCities) {
                // æ£€æŸ¥å®Œæ•´åŸå¸‚å
                if (city === normalizedInput) {
                    return city;
                }
                
                // æ£€æŸ¥å»æ‰åç¼€åçš„åŸå¸‚å
                for (const suffix of suffixes) {
                    if (city.endsWith(suffix)) {
                        const cityWithoutSuffix = city.slice(0, -suffix.length);
                        if (cityWithoutSuffix === normalizedInput) {
                            return city;
                        }
                    }
                }
            }
            
            // 4. å°è¯•åŒ¹é…ç›´è¾–å¸‚ï¼ˆåŒ—äº¬ã€ä¸Šæµ·ç­‰ï¼‰
            if (['åŒ—äº¬', 'å¤©æ´¥', 'ä¸Šæµ·', 'é‡åº†'].includes(normalizedInput)) {
                return normalizedInput + 'å¸‚';
            }
            
            // 5. å°è¯•åŒ¹é…é¦™æ¸¯æ¾³é—¨
            if (normalizedInput === 'é¦™æ¸¯' || normalizedInput === 'æ¾³é—¨') {
                return normalizedInput + 'ç‰¹åˆ«è¡Œæ”¿åŒº';
            }
            
            return null;
        }

        // æäº¤åŸå¸‚ç­”æ¡ˆ
        function submitCity(input) {
            if (isGameEnded) return;
            
            totalAttempts++;
            const matchedCity = matchCity(input);
            
            if (!matchedCity) {
                showMessage(`âŒ æ— æ³•è¯†åˆ«ã€${input}ã€‘ï¼Œè¯·æ£€æŸ¥è¾“å…¥ï¼`, "error");
                return;
            }

            // æ£€æŸ¥æ˜¯å¦å·²å¡«å†™
            if (filledCities.has(matchedCity)) {
                showMessage(`ä½ å·²ç»å¡«å†™è¿‡ã€${matchedCity}ã€‘å•¦ï¼`, "error");
                return;
            }

            // æ­£ç¡®ç­”æ¡ˆå¤„ç†
            correctAttempts++;
            filledCities.add(matchedCity);
            
            // æ›´æ–°ç»Ÿè®¡
            updateStats();
            
            // æ›´æ–°SVGæ ·å¼
            updateSVGCityStyle(matchedCity);
            
            // æ›´æ–°çœä»½åˆ—è¡¨
            renderProvinceList();
            
            // æç¤ºæˆåŠŸ
            showMessage(`âœ… æ­£ç¡®ï¼å·²å¡«å†™ã€${matchedCity}ã€‘`, "success");

            // æ¸…ç©ºè¾“å…¥æ¡†å¹¶è‡ªåŠ¨èšç„¦
            const inputElement = document.getElementById('city-input');
            inputElement.value = '';
            inputElement.focus();

            // æ£€æŸ¥æ˜¯å¦å…¨éƒ¨å®Œæˆ
            if (filledCities.size === allCities.length) {
                endGame();
            }
        }

        // æ›´æ–°SVGä¸­åŸå¸‚çš„æ ·å¼
        function updateSVGCityStyle(cityName) {
            const svgObj = document.getElementById('city-svg');
            const svgDoc = svgObj.contentDocument;
            if (!svgDoc) return;
            
            const cityElements = svgDoc.querySelectorAll(`[data-name="${cityName}"]`);
            
            cityElements.forEach(elem => {
                elem.style.fill = '#2ecc71';
            });
        }

        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        function updateStats() {
            document.getElementById('filled-count').textContent = filledCities.size;
        }

        // å¯åŠ¨è®¡æ—¶å™¨
        function startTimer() {
            startTime = Date.now();
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
                const seconds = (elapsed % 60).toString().padStart(2, '0');
                document.getElementById('timer').textContent = `${minutes}:${seconds}`;
            }, 1000);
        }

        // æ¨¡ç³ŠåŒ¹é…å‡½æ•°ï¼šå¤„ç†"å¹¿å·"ä¸"å¹¿å·å¸‚"çš„åŒ¹é…
        // ä¿®æ­£ï¼šç²¾å‡†åŒ¹é… JSON ä¸­çš„åŸå¸‚åè§„åˆ™
        function findAccuracy(cityName) {
            // æ­¥éª¤1ï¼šå…ˆå®šä¹‰ã€Œä»…ç§»é™¤å¸‚åç¼€ã€çš„å½’ä¸€åŒ–è§„åˆ™ï¼ˆé€‚é… JSON é‡Œ"å¹¿å·"å¯¹åº”ç³»ç»Ÿå†…"å¹¿å·å¸‚"ï¼‰
            const normalizeForCity = (name) => {
                // ä»…ç§»é™¤"å¸‚"åç¼€ï¼ˆå› ä¸º JSON é‡Œå¸‚ç»“å°¾çš„éƒ½çœç•¥äº†å¸‚ï¼‰
                if (name.endsWith('å¸‚')) {
                    return name.slice(0, -1); // å¹¿å·å¸‚ â†’ å¹¿å·
                }
                // éå¸‚ç»“å°¾çš„ï¼ˆå¦‚æ¾³é—¨ç‰¹åˆ«è¡Œæ”¿åŒºã€å‘¼å’Œæµ©ç‰¹ï¼‰ï¼Œç›´æ¥è¿”å›åŸåç§°
                return name;
            };

            // æ­¥éª¤2ï¼šç³»ç»Ÿå†…åŸå¸‚åå½’ä¸€åŒ–ï¼ˆå¦‚å¹¿å·å¸‚ â†’ å¹¿å·ï¼Œæ¾³é—¨ç‰¹åˆ«è¡Œæ”¿åŒº â†’ æ¾³é—¨ç‰¹åˆ«è¡Œæ”¿åŒºï¼‰
            const normalizedSysCity = normalizeForCity(cityName);
            
            // æ­¥éª¤3ï¼šéå† JSON æ•°æ®åŒ¹é…
            return accuracyData.find(item => {
                // JSON é‡Œçš„ city_name æœ¬èº«å°±æ˜¯å½’ä¸€åŒ–åçš„ï¼ˆå¹¿å·/æ¾³é—¨ç‰¹åˆ«è¡Œæ”¿åŒºï¼‰ï¼Œç›´æ¥å…¨ç­‰åŒ¹é…
                return item.city_name === normalizedSysCity;
            });
        }

        // æ­£æ€åˆ†å¸ƒç´¯ç§¯åˆ†å¸ƒå‡½æ•°è¿‘ä¼¼å€¼ (CDF)
        function calculateNormalCDF(z) {
            const t = 1 / (1 + 0.2316419 * Math.abs(z));
            const d = 0.3989423 * Math.exp(-z * z / 2);
            const p = d * t * (0.3193815 + t * (-0.3565638 + t * (1.781478 + t * (-1.821256 + t * 1.330274))));
            return z >= 0 ? 1 - p : p;
        }

        // ç»“æŸæ¸¸æˆ - æ–°å¢æœŸæœ›åˆ†å€¼å’Œæ­£æ€åˆ†å¸ƒè®¡ç®—
        function endGame() {
            if (isGameEnded) return;
            isGameEnded = true;
            clearInterval(timerInterval);
            
            // æ›´æ–°çœä»½åˆ—è¡¨ï¼Œæ˜¾ç¤ºæ‰€æœ‰åŸå¸‚ï¼ˆåŒ…æ‹¬æœªç­”å‡ºçš„ï¼‰
            renderProvinceList();
            
            // åŸæœ‰æ­£ç¡®ç‡è®¡ç®—
            const totalCities = 390;
            const accuracy = Math.round((filledCities.size / totalCities) * 100);
            const time = document.getElementById('timer').textContent;

            // æ–°å¢ï¼šè®¡ç®—æœŸæœ›åˆ†å€¼ã€æ–¹å·®ã€æ ‡å‡†å·®
            const score = filledCities.size; // ç”¨æˆ·å®é™…å¾—åˆ†
            let expectedValue = 0;   // æœŸæœ›å¾—åˆ† (Î¼)
            let variance = 0;        // æ–¹å·® (ÏƒÂ²)

            // è®¡ç®—æœŸæœ›åˆ†å’Œæ–¹å·® (åŸºäºæ³Šæ¾äºŒé¡¹åˆ†å¸ƒè¿‘ä¼¼)
            accuracyData.forEach(item => {
                const p = item.correct_percent / 100;
                expectedValue += p;
                variance += p * (1 - p);
            });

            const stdDev = Math.sqrt(variance); // æ ‡å‡†å·® (Ïƒ)
            
            // è®¡ç®—æ­£æ€åˆ†å¸ƒè¶…è¶Šç™¾åˆ†æ¯” (Z-Score)
            // Z = (x - Î¼) / Ïƒï¼Œå¤„ç†æ ‡å‡†å·®ä¸º0çš„æƒ…å†µ
            let zScore = 0;
            let percentile = 50;
            if (stdDev > 0) {
                zScore = (score - expectedValue) / stdDev;
                percentile = calculateNormalCDF(zScore) * 100;
            }

            // æ˜¾ç¤ºç»“æœ
            showResult(accuracy, time, score, expectedValue, percentile);
            
            showMessage("ğŸ‰ æ¸¸æˆç»“æŸï¼æŸ¥çœ‹ç»“æœç»Ÿè®¡", "success");
        }

        // æ˜¾ç¤ºç»“æœå¼¹çª— - æ–°å¢æœŸæœ›åˆ†å€¼å’Œè¶…è¶Šç™¾åˆ†æ¯”
        function showResult(accuracy, time, score, expectedValue, percentile) {
            // æ¸²æŸ“åŸºç¡€ç»Ÿè®¡
            const resultStats = document.getElementById('result-stats');
            resultStats.innerHTML = `
                <div class="result-stat">
                    <span class="result-label">å®ŒæˆåŸå¸‚</span>
                    <span class="result-value">${filledCities.size}/390</span>
                </div>
                <div class="result-stat">
                    <span class="result-label">æ€»ç”¨æ—¶</span>
                    <span class="result-value">${time}</span>
                </div>
                <div class="result-stat">
                    <span class="result-label">å°è¯•æ¬¡æ•°</span>
                    <span class="result-value">${totalAttempts}</span>
                </div>
                <div class="result-stat">
                    <span class="result-label">æ­£ç¡®æ¬¡æ•°</span>
                    <span class="result-value">${correctAttempts}</span>
                </div>
                <div class="result-stat">
                    <span class="result-label">æ­£ç¡®ç‡</span>
                    <span class="result-value result-accuracy">${accuracy}%</span>
                </div>
            `;

            // æ¸²æŸ“æœŸæœ›åˆ†å€¼å’Œæ­£æ€åˆ†å¸ƒç»Ÿè®¡
            const finalStats = document.getElementById('final-stats');
            finalStats.innerHTML = `
                <div style="font-size: 1.4rem; margin-bottom:10px;">ä½ çš„å¾—åˆ†: <span class="highlight-val">${score}</span></div>
                <div class="stat-detail">å…¨ç½‘æŒ‘æˆ˜è€…å¹³å‡åˆ†: <span class="highlight-val">${expectedValue.toFixed(2)}</span></div>
                <div class="stat-detail">ä½ çš„è¡¨ç°è¶…è¿‡äº†å…¨ç½‘ <span class="highlight-val">${percentile.toFixed(1)}%</span> çš„ç”¨æˆ·</div>
            `;

            // æ¸²æŸ“åŸå¸‚æ­£ç¡®ç‡åˆ—è¡¨
            renderCityAccuracyList();

            // æ˜¾ç¤ºå¼¹çª—
            document.getElementById('result-modal').style.display = 'flex';
        }

        // æ¸²æŸ“åŸå¸‚æ­£ç¡®ç‡åˆ—è¡¨
        // å®Œæ•´å®ç°ï¼šæ¸²æŸ“åŸå¸‚æ­£ç¡®ç‡åˆ—è¡¨ + æ­£ç¡®åŒ¹é…å·²å¡«å†™åŸå¸‚
        function renderCityAccuracyList() {
            const listContainer = document.getElementById('city-stats-list');
            // æ¸…ç©ºåŸæœ‰å†…å®¹ï¼ˆä¿ç•™æ ‡é¢˜ï¼‰
            listContainer.innerHTML = '<h3 style="margin-bottom: 1rem; font-size: 1.1rem; color: #2c3e50;">å…¨ç½‘åŸå¸‚è¯†åˆ«çƒ­åº¦æ¦œï¼ˆç»¿è‰²ä¸ºæ‚¨ç­”å¯¹ï¼‰</h3>';

            // æŒ‰æ­£ç¡®ç‡é™åºæ’åº
            const sortedAccuracy = [...accuracyData].sort((a, b) => b.correct_percent - a.correct_percent);

            sortedAccuracy.forEach(item => {
                // æ­¥éª¤1ï¼šåå‘æ¨å¯¼ç³»ç»Ÿå†…çš„åŸå¸‚åï¼ˆJSONé‡Œçš„city_name â†’ ç³»ç»Ÿå†…çš„å®Œæ•´åï¼‰
                let sysCityName = item.city_name;
                // å¦‚æœ JSON é‡Œçš„åç§°ä¸æ˜¯"ç‰¹åˆ«è¡Œæ”¿åŒº/è‡ªæ²»å·/åœ°åŒº/ç›Ÿ/æ—åŒº"ç»“å°¾ï¼Œä¸”ä¸å«"å¸‚"ï¼Œåˆ™è¡¥"å¸‚"
                const fullSuffixes = ['ç‰¹åˆ«è¡Œæ”¿åŒº', 'è‡ªæ²»å·', 'åœ°åŒº', 'ç›Ÿ', 'æ—åŒº'];
                const isFullName = fullSuffixes.some(suffix => sysCityName.endsWith(suffix));
                if (!isFullName && !sysCityName.includes('å¸‚')) {
                    sysCityName += 'å¸‚'; // å¹¿å· â†’ å¹¿å·å¸‚
                }

                // æ­¥éª¤2ï¼šåˆ¤æ–­ç”¨æˆ·æ˜¯å¦å¡«å†™è¿‡è¯¥åŸå¸‚
                const isAnsweredCorrectly = filledCities.has(sysCityName);

                // æ­¥éª¤3ï¼šåˆ›å»ºè¡Œå…ƒç´ 
                const row = document.createElement('div');
                row.className = 'city-stat-row';

                // åŸå¸‚åç§°åˆ—
                const cityNameCol = document.createElement('div');
                cityNameCol.className = 'city-name';
                cityNameCol.textContent = item.city_name; // æ˜¾ç¤º JSON é‡Œçš„åç§°ï¼ˆå¹¿å·/æ¾³é—¨ç‰¹åˆ«è¡Œæ”¿åŒºï¼‰

                // è¿›åº¦æ¡å®¹å™¨
                const barContainer = document.createElement('div');
                barContainer.className = 'bar-container';

                // è¿›åº¦æ¡å¡«å……ï¼ˆç»¿è‰²=ç­”å¯¹ï¼Œçº¢è‰²=ç­”é”™/æœªç­”ï¼‰
                const barFill = document.createElement('div');
                barFill.className = `bar-fill ${isAnsweredCorrectly ? 'correct' : ''}`;
                barFill.style.width = `${item.correct_percent}%`;

                // ç™¾åˆ†æ¯”æ–‡æœ¬
                const percentCol = document.createElement('div');
                percentCol.className = 'percent-text';
                percentCol.textContent = `${item.correct_percent}%`;

                // ç»„è£…
                barContainer.appendChild(barFill);
                row.appendChild(cityNameCol);
                row.appendChild(barContainer);
                row.appendChild(percentCol);
                listContainer.appendChild(row);
            });
        }

        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
        function showMessage(text, type) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = `message ${type}`;
            
            setTimeout(() => {
                messageEl.className = 'message';
            }, 3000);
        }

        // æ˜¾ç¤ºæç¤ºæ¡†
        function showTooltip(e, cityName) {
            tooltip.textContent = cityName;
            tooltip.style.left = `${e.clientX + 10}px`;
            tooltip.style.top = `${e.clientY + 10}px`;
            tooltip.style.opacity = 1;
        }

        // éšè—æç¤ºæ¡†
        function hideTooltip() {
            tooltip.style.opacity = 0;
        }

        // é‡ç½®æŒ‘æˆ˜
        function resetChallenge() {
            // æ¸…ç©ºå·²å¡«åŸå¸‚
            filledCities.clear();
            
            // é‡ç½®ç»Ÿè®¡
            totalAttempts = 0;
            correctAttempts = 0;
            isGameEnded = false;
            
            // é‡ç½®ç¼©æ”¾çŠ¶æ€
            isZoomed = false;
            scale = 1;
            translateX = 0;
            translateY = 0;
            
            // é‡ç½®è®¡æ—¶å™¨
            clearInterval(timerInterval);
            startTimer();
            
            // æ›´æ–°UI
            updateStats();
            renderProvinceList();
            
            // é‡ç½®SVGæ ·å¼
            const svgObj = document.getElementById('city-svg');
            if (svgObj.contentDocument) {
                const cityElements = svgObj.contentDocument.querySelectorAll('[data-name]');
                cityElements.forEach(elem => {
                    elem.style.fill = '';
                });
                
                // é‡ç½®åœ°å›¾ç¼©æ”¾
                const svgElement = svgObj.contentDocument.querySelector('svg');
                if (svgElement) {
                    svgElement.style.transform = `translate(0px, 0px) scale(1)`;
                    svgElement.style.transformOrigin = '0 0';
                }
            }
            
            // èšç„¦è¾“å…¥æ¡†
            document.getElementById('city-input').focus();
            
            showMessage("ğŸ”„ å·²é‡ç½®æŒ‘æˆ˜ï¼Œé‡æ–°å¼€å§‹ï¼", "success");
        }

        // äº‹ä»¶ç›‘å¬
        document.addEventListener('DOMContentLoaded', () => {
            // åˆå§‹åŒ–
            init();

            // æäº¤æŒ‰é’®ç‚¹å‡»
            document.getElementById('submit-btn').addEventListener('click', () => {
                const input = document.getElementById('city-input').value.trim();
                if (input) {
                    submitCity(input);
                } else {
                    showMessage("è¯·è¾“å…¥åœ°çº§å¸‚åç§°ï¼", "error");
                }
            });

            // ç»“æŸæŒ‰é’®ç‚¹å‡»
            document.getElementById('end-btn').addEventListener('click', () => {
                if (!isGameEnded) {
                    endGame();
                }
            });

            // è¾“å…¥æ¡†å›è½¦æäº¤
            document.getElementById('city-input').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    const input = e.target.value.trim();
                    if (input) {
                        submitCity(input);
                    }
                }
            });

            // é‡ç½®æŒ‰é’®
            document.getElementById('reset-btn').addEventListener('click', resetChallenge);

            // å…³é—­ç»“æœå¼¹çª—
            document.getElementById('close-result-btn').addEventListener('click', () => {
                document.getElementById('result-modal').style.display = 'none';
            });

            // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
            document.getElementById('result-modal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('result-modal')) {
                    document.getElementById('result-modal').style.display = 'none';
                }
            });

            // åˆå§‹èšç„¦è¾“å…¥æ¡†
            document.getElementById('city-input').focus();
        });
    </script>
</body>
</html>